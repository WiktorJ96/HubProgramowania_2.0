<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Procedury i Funkcje Użytkownika</title>
  <link rel="stylesheet" href="../styles.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
</head>
<body>
  <div class="container">
    <h1>Procedury i Funkcje Użytkownika w SQL</h1>

    <p>
      <strong>Procedury</strong> (<em>stored procedures</em>) i <strong>funkcje</strong> (<em>user-defined functions</em>)
      pozwalają zapisać fragmenty logiki po stronie bazy. To jak <em>gotowe przepisy</em> w kuchni:
      zamiast za każdym razem robić wszystko ręcznie, wywołujesz nazwę przepisu z parametrami.
    </p>

    <div class="note">
      <strong>Uwaga na dialekty:</strong> poniższe przykłady korzystają głównie z <em>MySQL/MariaDB</em> (np. <code>DELIMITER</code>, <code>SIGNAL</code>).
      W PostgreSQL/SQL Server składnia bywa inna, ale logika pozostaje ta sama.
    </div>

    <!-- =================== DANE WEJŚCIOWE =================== -->
    <details open>
      <summary class="table-title">Dane wejściowe (przykładowe tabele)</summary>
      <div class="grid-two">
        <table class="db-table">
          <caption class="mini">accounts</caption>
          <thead><tr><th>id</th><th>name</th><th>balance</th></tr></thead>
          <tbody>
            <tr><td>1</td><td>Ala</td><td>1000.00</td></tr>
            <tr><td>2</td><td>Bartek</td><td>500.00</td></tr>
          </tbody>
        </table>
        <table class="db-table">
          <caption class="mini">log_messages</caption>
          <thead><tr><th>id</th><th>msg</th></tr></thead>
          <tbody>
            <tr><td>—</td><td>(puste na start)</td></tr>
          </tbody>
        </table>
      </div>
      <p class="mini">To dane poglądowe do wizualizacji wyników.</p>
    </details>

    <!-- =================== CREATE PROCEDURE =================== -->
    <h2>Jak stworzyć procedurę? (CREATE PROCEDURE)</h2>

    <p><strong>Przykład: dodawanie nowego konta</strong></p>

    <pre><code class="language-sql">-- Zmieniamy znak końca polecenia, bo procedura zawiera średniki
DELIMITER //

CREATE PROCEDURE add_account(
  IN p_name VARCHAR(50),      -- parametr wejściowy: nazwa konta
  IN p_balance DECIMAL(10,2)  -- parametr wejściowy: startowe saldo
)
BEGIN
  -- 1) Wstaw nowe konto do tabeli accounts na podstawie parametrów
  INSERT INTO accounts(name, balance)
  VALUES (p_name, p_balance);
END;
//

-- Przywracamy standardowy znak końca
DELIMITER ;

-- Wywołanie:
CALL add_account('Celina', 250.00);</code></pre>

    <details open>
      <summary class="table-title">Wynik po <code>CALL add_account('Celina', 250.00)</code></summary>
      <table class="db-table">
        <thead><tr><th>id</th><th>name</th><th>balance</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>Ala</td><td>1000.00</td></tr>
          <tr><td>2</td><td>Bartek</td><td>500.00</td></tr>
          <tr><td><strong>3</strong></td><td><strong>Celina</strong></td><td><strong>250.00</strong></td></tr>
        </tbody>
      </table>
      <p class="mini">Procedura wykonuje <em>INSERT</em> ze wskazanymi parametrami.</p>
    </details>

    <!-- =================== CREATE FUNCTION =================== -->
    <h2>Jak stworzyć funkcję? (CREATE FUNCTION)</h2>

    <p><strong>Przykład: funkcja licząca łączną sumę sald</strong></p>

    <pre><code class="language-sql">DELIMITER //

CREATE FUNCTION total_balance()
RETURNS DECIMAL(15,2)         -- zwracany typ (†)
DETERMINISTIC                 -- dla tych samych danych → ten sam wynik
BEGIN
  DECLARE v_sum DECIMAL(15,2);              -- zmienna lokalna
  SELECT SUM(balance) INTO v_sum FROM accounts;  -- policz sumę sald
  RETURN v_sum;                              -- zwróć wynik
END;
//

DELIMITER ;

-- Użycie w SELECT:
SELECT total_balance() AS suma_sald;  -- np. 1750.00 po dopisaniu Celiny</code></pre>

    <details>
      <summary class="table-title">Wynik (przykładowy)</summary>
      <table class="db-table">
        <thead><tr><th>suma_sald</th></tr></thead>
        <tbody>
          <tr><td>1750.00</td></tr>
        </tbody>
      </table>
      <p class="mini">1000 + 500 + 250 = 1750.00</p>
    </details>

    <!-- =================== PARAMETRY IN / OUT / INOUT =================== -->
    <h2>Rodzaje parametrów w procedurach</h2>
    <ul>
      <li><strong>IN</strong> – wejście (podajesz wartość do procedury),</li>
      <li><strong>OUT</strong> – wyjście (procedura wpisze wynik do zmiennej/parametru),</li>
      <li><strong>INOUT</strong> – jednocześnie wejście i wyjście (procedura może zmodyfikować przekazaną wartość).</li>
    </ul>

    <pre><code class="language-sql">DELIMITER //

CREATE PROCEDURE demo_params(
  IN  p_in  INT,          -- wejście
  OUT p_out INT,          -- wyjście
  INOUT p_inout INT       -- wejście/wyjście
)
BEGIN
  SET p_out   = p_in * 2;     -- do OUT trafia p_in×2
  SET p_inout = p_inout + 5;  -- INOUT zostaje podbity o 5
END;
//

DELIMITER ;

-- Wywołanie:
SET @x = 10;         -- INOUT start
CALL demo_params(7, @y, @x);
SELECT @y AS out_val, @x AS inout_val;  -- out_val=14, inout_val=15</code></pre>

    <details>
      <summary class="table-title">Wynik wywołania <code>demo_params</code></summary>
      <table class="db-table">
        <thead><tr><th>zmienna</th><th>wartość</th></tr></thead>
        <tbody>
          <tr><td>@y (OUT)</td><td>14</td></tr>
          <tr><td>@x (INOUT)</td><td>15</td></tr>
        </tbody>
      </table>
      <p class="mini"><code>OUT = IN×2</code>; <code>INOUT = INOUT+5</code>.</p>
    </details>

    <!-- =================== PĘTLE =================== -->
    <h2>Pętle w procedurach (Loops)</h2>

    <p><strong>Przykład: prosta pętla WHILE</strong></p>

    <pre><code class="language-sql">DELIMITER //

CREATE PROCEDURE loop_example()
BEGIN
  DECLARE i INT DEFAULT 1;        -- licznik od 1

  WHILE i &lt;= 5 DO                 -- dopóki i ≤ 5
    INSERT INTO log_messages(msg)
    VALUES (CONCAT('Wiadomość ', i));
    SET i = i + 1;                -- zwiększ i
  END WHILE;
END;
//

DELIMITER ;

CALL loop_example();</code></pre>

    <details>
      <summary class="table-title">Wynik po <code>CALL loop_example()</code></summary>
      <table class="db-table">
        <thead><tr><th>id</th><th>msg</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>Wiadomość 1</td></tr>
          <tr><td>2</td><td>Wiadomość 2</td></tr>
          <tr><td>3</td><td>Wiadomość 3</td></tr>
          <tr><td>4</td><td>Wiadomość 4</td></tr>
          <tr><td>5</td><td>Wiadomość 5</td></tr>
        </tbody>
      </table>
      <p class="mini">Pętla dodała 5 nowych wierszy do <code>log_messages</code>.</p>
    </details>

    <!-- =================== WARUNKI + SIGNAL =================== -->
    <h2>Warunki w procedurach (IF...THEN...ELSE)</h2>

    <p><strong>Przykład: sprawdzanie, czy można zmniejszyć saldo</strong></p>

    <pre><code class="language-sql">DELIMITER //

CREATE PROCEDURE adjust_balance(
  IN p_id INT,               -- ID konta
  IN p_amount DECIMAL(10,2)  -- kwota dodatnia/ujemna
)
BEGIN
  DECLARE current_balance DECIMAL(10,2);

  -- pobierz aktualne saldo
  SELECT balance INTO current_balance
  FROM accounts
  WHERE id = p_id
  FOR UPDATE;  -- zablokuj wiersz (bezpieczne równolegle)

  -- jeśli nowe saldo byłoby ujemne → zgłoś błąd
  IF current_balance + p_amount &lt; 0 THEN
    SIGNAL SQLSTATE '45000'
      SET MESSAGE_TEXT = 'Niewystarczające środki';
  ELSE
    UPDATE accounts
    SET balance = current_balance + p_amount
    WHERE id = p_id;
  END IF;
END;
//

DELIMITER ;

-- Przykład użycia:
-- CALL adjust_balance(1, -200.00);  -- OK (1000-200=800)
-- CALL adjust_balance(2, -1000.00); -- BŁĄD: niewystarczające środki</code></pre>

    <details>
      <summary class="table-title">Wynik (scenariusze)</summary>
      <table class="db-table">
        <thead><tr><th>Operacja</th><th>Saldo przed</th><th>Saldo po</th><th>Efekt</th></tr></thead>
        <tbody>
          <tr>
            <td><code>CALL adjust_balance(1, -200.00)</code></td>
            <td>1000.00</td>
            <td><strong>800.00</strong></td>
            <td>OK (aktualizacja)</td>
          </tr>
          <tr>
            <td><code>CALL adjust_balance(2, -1000.00)</code></td>
            <td>500.00</td>
            <td>500.00</td>
            <td><strong>Błąd</strong> „Niewystarczające środki” (SIGNAL)</td>
          </tr>
        </tbody>
      </table>
      <p class="mini"><code>FOR UPDATE</code> chroni przed wyścigiem przy równoczesnych modyfikacjach.</p>
    </details>

    <!-- =================== DOBRE PRAKTYKI =================== -->
    <h2>Dobre praktyki</h2>
    <ul>
      <li>Waliduj parametry na wejściu (np. zakresy, formaty) i reaguj błędem (<code>SIGNAL</code>).</li>
      <li>Trzymaj operacje modyfikujące w transakcjach; rozważ blokady wierszy (<code>FOR UPDATE</code>).</li>
      <li>Funkcje używaj do zwracania wartości (łatwo wstawić w <code>SELECT</code>); cięższa logika → procedura.</li>
      <li>Unikaj wykonywania „ciężkich” zapytań w pętli – lepiej przetwarzać zbiorczo (set-based).</li>
      <li>Loguj zdarzenia w pomocniczej tabeli (np. <code>log_messages</code>) przy nietypowych sytuacjach.</li>
    </ul>

    <p class="small">
      Różnice między silnikami: w PostgreSQL tworzy się funkcje w PL/pgSQL (<code>CREATE FUNCTION ... LANGUAGE plpgsql</code>);
      w SQL Server używasz T-SQL i <code>CREATE PROCEDURE</code>/<code>CREATE FUNCTION</code> z inną składnią.
    </p>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-sql.min.js"></script>

  <!-- Styl TYLKO do wizualizacji; nie rusza Twojego styles.css -->
  <style>
    .db-table{width:100%;border-collapse:collapse;margin:.5rem 0}
    .db-table th,.db-table td{border:1px solid #1f2937;padding:.5rem .65rem;text-align:left;vertical-align:top}
    .db-table th{background:#0e1729;color:#dbe2ea}
    .null{color:#9ca3af;font-style:italic}
    details{margin:.75rem 0;border:1px solid #1f2937;border-radius:.5rem;padding:.25rem .5rem;background:#0e1729}
    details[open]{background:#111827}
    summary{cursor:pointer;list-style:none}
    summary::-webkit-details-marker{display:none}
    .table-title{font-weight:600;margin:.25rem 0}
    .mini{color:#a7b0be;font-size:.95rem;margin:.25rem 0 .5rem}
    .note{border-left:4px solid #10b981;padding:.75rem 1rem;background:#0e1729;border-radius:.5rem;margin:1rem 0;color:#cfe3d8}
    .small{color:#a7b0be;font-size:.95rem}
    .grid-two{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    @media (max-width: 900px){.grid-two{grid-template-columns:1fr}}
  </style>
</body>
</html>
